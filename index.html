<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RAU-01 — AI</title>

<script src="https://cdn.tailwindcss.com"></script>

<style>
/* --- Design Styles --- */
body {
  background: #0d1117; /* GitHub dark style */
  color: #e5e7eb;
  font-family: 'Inter', sans-serif;
}

/* soft glass */
.glass {
  background: rgba(17,24,39,0.8); /* dark gray */
  backdrop-filter: blur(10px);
  border: 1px solid rgba(255,255,255,0.04);
}

.chat-bubble-user {
  background: #1f2937;
  border: 1px solid rgba(255,255,255,0.05);
}

.chat-bubble-ai {
  background: #020617;
  border: 1px solid rgba(255,255,255,0.05);
}

textarea {
  background: #020617 !important;
}

/* Scrollbar */
::-webkit-scrollbar {
  width: 6px;
}
::-webkit-scrollbar-thumb {
  background: #374151;
  border-radius: 10px;
}

/* Ensure the chat area takes up the remaining height */
#chatArea {
    min-height: 0; /* Important for flex-1 */
}

/* --- Utility Classes for Chat Content --- */
.ai-text p {
    margin-bottom: 0.5rem;
    line-height: 1.6;
}
</style>
</head>

<body class="h-screen flex text-white">

<!-- Sidebar - Hidden on mobile, shown on md and larger screens -->
<div class="hidden md:flex md:w-64 glass p-4 flex-col items-center md:items-start">
  <h1 class="text-2xl font-bold mb-6 text-blue-400">
    RAU-01
  </h1>

  <!-- Desktop-only Clear Chat button -->
  <button onclick="clearChat()" class="bg-red-500/20 hover:bg-red-600/30 w-full py-2 rounded-lg text-sm mt-auto transition duration-200">
    Clear Chat
  </button>
</div>


<!-- Main Area -->
<div class="flex-1 flex flex-col">

  <!-- Header -->
  <div class="glass p-4 border-b border-white/10 shrink-0 flex items-center justify-between">
    <div>
        <h2 class="text-xl font-semibold">RAU-01 — AI Assistant</h2>
        <p class="text-sm text-white/50">Grounded. Smart. Precise.</p>
    </div>
    <!-- Mobile-only Clear Chat button -->
    <button onclick="clearChat()" 
            class="md:hidden bg-red-500/20 hover:bg-red-600/30 px-3 py-1 rounded-lg text-xs transition duration-200">
        Clear Chat
    </button>
  </div>

  <!-- Chat Area -->
  <div id="chatArea" class="flex-1 overflow-y-auto p-6 space-y-6"></div>

  <!-- Input -->
  <div class="glass p-4 flex gap-4 shrink-0">
    <textarea id="promptInput" rows="1"
      class="flex-1 bg-transparent resize-none outline-none p-3 rounded-xl border border-white/20 text-white transition duration-200 focus:border-blue-500"
      placeholder="Send message to RAU-01..."></textarea>

    <button onclick="getAIResponse()" id="submitBtn"
      class="bg-blue-600 hover:bg-blue-700 px-4 py-2 md:px-6 md:py-3 rounded-xl font-bold transition duration-200 shadow-lg hover:shadow-blue-500/50 text-sm md:text-base">
      Send
    </button>
  </div>

</div>

<script>
// ====================================================================================
// !!! ACTION REQUIRED: FIX THE API ENDPOINT !!!
//
// You must replace 'YOUR_PUBLIC_API_ENDPOINT_HERE' with the public URL of your 
// *deployed backend* service. This is a crucial step for the AI to work.
//
// Example format: 'https://my-service-xxxxxx-uc.a.run.app/ask_ai'
// ====================================================================================
const API_ENDPOINT = 'https://my-rau-ai.vercel.app/ask_ai'; 

const promptInput = document.getElementById('promptInput');
const submitBtn = document.getElementById('submitBtn');
const chatArea = document.getElementById('chatArea');

// --- Utility Functions ---

function saveChat() {
  // We'll only save the raw HTML of the chat area
  localStorage.setItem("rau_chat", chatArea.innerHTML);
}

function loadChat() {
  const saved = localStorage.getItem("rau_chat");
  if (saved) chatArea.innerHTML = saved;
}

function clearChat() {
  chatArea.innerHTML = '';
  localStorage.removeItem("rau_chat");
}

function addMessage(type, content) {
  const div = document.createElement("div");
  // Set class for styling
  div.className = `p-4 rounded-xl max-w-xl shadow-xl ${type === "user" ? "chat-bubble-user ml-auto" : "chat-bubble-ai"}`;
  
  if (type === "user") {
    // User message is plain text, apply line breaks
    div.innerHTML = content.replace(/\n/g, "<br>");
  } else {
    // AI message contains HTML (for text and sources), insert directly
    div.innerHTML = content;
  }
  
  chatArea.appendChild(div);
  chatArea.scrollTop = chatArea.scrollHeight;
  saveChat();
}

// --- Event Listeners ---

loadChat();

// Enable pressing Enter to send message
promptInput.addEventListener("keydown", e => {
  if (e.key === "Enter" && !e.shiftKey) {
    e.preventDefault();
    getAIResponse();
  }
});

// --- Main AI Logic ---

async function getAIResponse() {
  const prompt = promptInput.value.trim();
  if (!prompt) return;

  addMessage("user", prompt);
  promptInput.value = "";

  submitBtn.disabled = true;
  submitBtn.textContent = "Thinking...";
  
  try {
    // Check if the placeholder URL is still in use
    if (API_ENDPOINT.includes("https://my-rau-ai.vercel.app/ask_ai")) {
        throw new Error("Local endpoint is no longer supported. Please update the API_ENDPOINT constant with the public URL of your deployed backend.");
    }

    const response = await fetch(API_ENDPOINT, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ prompt })
    });

    const data = await response.json();
    let messageContent = "";

    if (!response.ok || data.error) {
      // Handle HTTP errors or errors returned by the server
      const errorDetail = data.error || `HTTP Status ${response.status}`;
      messageContent = `<span class="text-red-400 font-bold">⚠️ Error:</span> ${errorDetail}. Check your backend logs.`;
    } else {
      // 1. Get the AI Text, replacing newlines with paragraphs for structure
      const rawText = data.text || "I was unable to generate a meaningful response for that query.";
      const formattedText = rawText.split('\n').map(p => p.trim()).filter(p => p.length > 0).map(p => `<p>${p}</p>`).join('');
      
      messageContent = `<div class="ai-text">${formattedText}</div>`;

      // 2. Handle and display sources if available
      const sources = data.sources || [];
      if (sources.length > 0) {
        let sourceHtml = '<div class="mt-4 pt-4 border-t border-white/10">';
        sourceHtml += '<p class="text-xs font-semibold text-blue-400 mb-2">Grounded Sources:</p>';
        sourceHtml += '<ul class="space-y-1">';
        
        sources.forEach((source) => {
            // Use a simple link icon (inline SVG for maximum compatibility)
            const linkIcon = `
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-blue-400 shrink-0 mt-0.5">
                    <path d="M15 3h6v6"/><path d="M10 14V4"/><path d="M4 10h10V4h6v10z"/><path d="M14 10H4v10h10z"/>
                </svg>
            `;
            sourceHtml += `
                <li class="flex items-start">
                    ${linkIcon}
                    <a href="${source.uri}" target="_blank" rel="noopener noreferrer" 
                       class="ml-2 text-xs text-white/70 hover:text-blue-400 truncate transition duration-150"
                       title="${source.title || source.uri}">
                       ${source.title || source.uri}
                    </a>
                </li>
            `;
        });
        sourceHtml += '</ul></div>';
        
        messageContent += sourceHtml;
      }
    }
    
    addMessage("ai", messageContent);

  } catch (err) {
    let errorMessage = '<span class="text-red-400 font-bold">⚠️ Connection Failed.</span>';
    
    if (err.message && err.message.includes("update the API_ENDPOINT")) {
         errorMessage += `<p class="text-sm mt-2">${err.message}</p>`;
    } else {
        errorMessage += `<p class="text-sm mt-2">Could not reach the server. Make sure your Python backend is deployed and running correctly.</p>`;
    }
    
    addMessage("ai", errorMessage);
  }

  // Final UI Reset
  submitBtn.disabled = false;
  submitBtn.textContent = "Send";
}
</script>
</body>
</html>
